<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda Digital — Calendario Pro (refactor)</title>

  <!--
    =============================================================
    AGENDA + CALENDARIO (REFactor 2025-08-17)
    - Mantiene los mismos IDs y contratos públicos para NO romper login ni Firestore.
    - Usa solo HTML+CSS+JS (sin librerías pesadas).
    - Vistas: Mes / Semana / Día con rejilla de horas.
    - Editor de eventos accesible, drag & drop con límites.
    - Badges "+n" en mes, notificaciones 10 min antes.
    - Persistencia en Firestore vía window.firebaseFirestore + guardarDatosUsuarioEnFirestore().
    - Compatibilidad con mapa legacy 'eventos' (boolean) y nuevo 'eventosPro' (array de eventos por día).
    - Accesible (ARIA), responsive y con estilo tipo Google Calendar liviano.
    =============================================================
  -->

  <style>
    :root{
      --bg: #0b0d10;
      --paper:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-weak:#e0e7ff;
      --accent:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ring: rgba(37,99,235,.35);
      --border:#e5e7eb;
      --radius:14px;
      --shadow:0 10px 40px rgba(0,0,0,.15);
    }

    /* Fondo */
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg) url('fondopantalla1.png') center/cover no-repeat fixed; color:#fff;}

    /* ===== Login Overlay (IDs preservados) ===== */
    #loginModal{position:fixed; inset:0; z-index:99999; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35)}
    .login-container{ width:min(980px,95vw); display:grid; grid-template-columns:1fr 1fr; border-radius:18px; overflow:hidden; background:#fff; color:#111; box-shadow:var(--shadow) }
    .login-left{ background: linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.35)), url('fondopantalla1.png') center/cover no-repeat; color:#fff; padding: 46px 38px; display:flex; flex-direction:column; justify-content:center;}
    .login-left h1{ font-size: 2.6rem; line-height:1.05; margin:0 0 14px 0; }
    .login-left p{ margin:0; font-size:1.02rem; opacity:.95; }
    .social-icons{ margin-top: 26px; display:flex; gap:12px; }
    .social-icons a{ width:36px; height:36px; border-radius:50%; background: rgba(255,255,255,.14); display:grid; place-items:center; color:#fff; text-decoration:none; }
    .login-right{ padding:42px; display:flex; flex-direction:column; justify-content:center; }
    .login-right h2{ margin:0 0 14px 0; color:#111; font-size:1.6rem; }
    .login-form{ display:flex; flex-direction:column; gap:14px; }
    .login-form input{ padding:12px; border-radius:10px; border:1px solid #d6d6d6; font-size:1rem; width:100%; background:#fff; }
    .login-form button{ padding:12px; border-radius:10px; border:none; background:var(--primary); color:#fff; font-weight:800; cursor:pointer; box-shadow: 0 6px 18px rgba(37,99,235,.25); }
    .remember{ display:flex; align-items:center; gap:8px; font-size:.92rem; color:#555; }
    .google-btn{ margin-top: 14px; display:inline-flex; align-items:center; gap:10px; background:#fff; border:1.5px solid var(--border); color:#111; font-weight:700; padding:12px 16px; border-radius:10px; cursor:pointer; }
    .google-btn img{ width:24px; height:24px; }
    .switch-auth{ margin: 14px 0 0 0; font-size:.95rem; color:#555; }
    .switch-auth a{ color:#2563eb; text-decoration:none; font-weight:700; }
    .login-error{ margin-top:12px; min-height:22px; color:#d32f2f; font-size:.95rem; }
    @media (max-width: 780px){ .login-container{ grid-template-columns:1fr; } .login-left{ display:none; } }

    /* ===== App Stage (agenda + overlay calendario) ===== */
    .stage{ position:fixed; inset:0; display:grid; place-items:center; }
    .agenda{ position:relative; width:min(46vw,420px); aspect-ratio:7/10; transform-style:preserve-3d; }
    .tapa{ position:absolute; inset:0; border-radius:14px; background: linear-gradient(180deg,#0e1114,#2f373d); box-shadow:0 26px 60px rgba(0,0,0,.58); transform-origin:left center; backface-visibility:hidden; z-index:2; cursor:pointer; transition: transform 1s cubic-bezier(.77,0,.175,1), box-shadow .5s }
    .tapa:hover{ transform: scale(1.03) }
    .lomo{ position:absolute; left:-22px; top:0; bottom:0; width:28px; background: linear-gradient(90deg,#040506,#0b0e11 45%,#040506); border-radius:10px 0 0 10px; }
    .banda{ position:absolute; left:32px; top:18px; bottom:18px; width:72px; border-radius:10px; background: linear-gradient(180deg,#41d7c6,#0aa6b1); display:flex; align-items:center; justify-content:center; writing-mode: vertical-rl; transform: rotate(180deg); font-weight:900; font-size:32px; color:#01292a; }
    .cara{ position:absolute; inset:24px 24px 24px 132px; }
    .mes-portada{ font-style:italic; font-weight:600; font-size:24px; color:#dff9f6; }
    .dia-wrap{ margin-top:20px; display:flex; align-items:center; justify-content:center; min-width:90px; min-height:90px; border-radius:12px; background: rgba(255,255,255,0.05); }
    .dia-portada{ font-weight:900; font-size:54px; }
    .hora-actual{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 1.1rem; color: #b2e0f7; text-shadow: 0 1px 4px #1116; margin-top: 8px; letter-spacing: .04em; user-select: none; }

    .indice{ position:absolute; inset:0; border-radius:14px; background:#fff; color:#111; padding:0; box-shadow: 0 26px 60px rgba(0,0,0,.35); transform: rotateY(180deg) translateX(60px) scale(.95); opacity:0; backface-visibility:hidden; overflow:auto; z-index:1; transition: opacity .7s cubic-bezier(.77,0,.175,1), transform .7s cubic-bezier(.77,0,.175,1); display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100%;}
    .agenda.abierta .tapa{ transform: rotateY(-180deg) scale(1.02) translateX(-10px); z-index:0; box-shadow:none; }
    .agenda.abierta .indice{ opacity:1; transform: rotateY(0deg) translateX(0) scale(1); z-index:2; }

    .indice-content{ position:relative; z-index:1; width: 90%; max-width: 520px; margin: 0 auto; text-align:center; padding: 32px 0 16px 0; }
    .indice-content h2{ font-family: Georgia, serif; font-size: clamp(2rem, 4vw, 3rem); color:#1f2937; margin: 0 0 24px 0; }
    .indice-table{ width:100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
    .indice-table td{ font-size:1.05rem; font-weight:700; padding:12px 6px; text-align:center; border-bottom:3px solid #222; cursor:pointer; user-select:none; }
    .indice-table tr td:first-child{ border-right:3px solid #222 }
    .indice-table tr:last-child td{ border-bottom:none }
    .indice-table td:hover{ background:#f5f5ff }
    .mes-actual{ color:#22c55e; font-weight:900; text-decoration: underline; background: rgba(34,197,94,0.07); border-radius: 6px; }
    .indice-row-actions{ display:flex; align-items:center; justify-content:center; gap:12px; margin:10px 0 0 0 }
    .indice-flecha-btn,.indice-btn{ background:#bfc6fa; color:#222; font-weight:700; font-size:1rem; border-radius: 14px; padding: 8px 18px; border:none; cursor:pointer; }
    .indice-flecha-btn:hover,.indice-btn:hover{ background:#a3b0f7 }

    /* ===== Overlay Calendario ===== */
    .calendario{ position: fixed; inset: 0; display: grid; place-items: center; z-index: 2000; background: rgba(0,0,0,0.22); opacity: 0; pointer-events: none; transform: scale(.98); transition: opacity .35s, transform .35s; backdrop-filter: blur(2.5px) brightness(0.98); }
    .calendario.visible{ opacity:1; pointer-events:auto; transform: scale(1) }
    .calendario-bg{ position:absolute; inset:0; z-index:0; pointer-events:none; background: linear-gradient(135deg, #b2f0f7 0%, #e0f7fa 100%); opacity:.22 }

    .calendario-content{ position: relative; z-index:1; width: clamp(340px, 94vw, 1100px); height: clamp(360px, 92vh, 780px); background: var(--paper); color:var(--ink); border-radius: 22px; box-shadow: 0 8px 48px #2563eb40; overflow: hidden; display:flex; flex-direction: column;}
    .cal-header{ display:flex; align-items:center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border); background:#fff; position: sticky; top:0; z-index: 10; }
    .calendario-nav-btn{ background:#eef2ff; border:1px solid #dbe2ff; border-radius: 10px; width: 40px; height: 40px; display:grid; place-items: center; cursor:pointer; }
    #calTitulo{ font-family: Georgia, serif; font-size: clamp(1.2rem, 3.2vw, 2rem); margin: 0 8px; }
    .toolbar{ margin-left:auto; display:flex; gap:8px }
    .tool-btn{ background:#f6f7fb; border:1px solid #e7e9f3; padding:8px 12px; border-radius: 10px; cursor:pointer; font-weight:700; }

    .calpro-bar{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 10px 0 }
    .calpro-btn{ border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer; }
    .calpro-btn.active{ background:#111; color:#fff; border-color:#111; }
    .calpro-badge{ font-size:.78rem; padding:.5px 6px; border-radius:999px; background:#eef2ff; border:1px solid #e0e7ff; color:#1e40af; }

    .cal-main{ display:grid; grid-template-columns: 1fr min(26ch, 28%); gap: 12px; padding: 12px; height: 100%; overflow: hidden; }
    .cal-grid-wrap{ overflow:auto; border-radius: 12px; border:1px solid var(--border); background:#f8fafc }
    .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(72px, 1fr); gap: 8px; padding: 10px; min-height: 420px; align-content: start; }

    .cal-dia-header{ background: #fffbe7; color: #1f2937; font-weight: 900; font-size: .95rem; border-bottom: 2px solid var(--warn); border-radius: 10px; display:grid; place-items:center; padding: 8px; user-select:none; }

    .cal-dia{ background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow: 0 1px 1px rgba(0,0,0,.03); display:flex; flex-direction:column; gap:6px; padding: 6px; position: relative; cursor:pointer; transition: box-shadow .12s, border-color .12s, background .12s; min-height:84px; outline:none; }
    .cal-dia:hover{ box-shadow: 0 10px 32px rgba(37,99,235,.12); border-color:#c7d2fe; background:#f8fbff }
    .cal-dia:focus-visible{ box-shadow: 0 0 0 4px var(--ring) }
    .cal-dia-hoy{ background:#ecfeff; border:2px solid var(--accent) }
    .cal-dia-num{ font-weight:900; font-size:.95rem; line-height:1 }

    .month-list{ display:flex; flex-direction:column; gap:6px; margin-top:auto }
    .month-event{ display:flex; align-items:center; gap:6px; font-size:.85rem; background:#eef2ff; border:1px solid #c7d2fe; border-radius:10px; padding:3px 6px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .month-more{ position:absolute; right:6px; bottom:6px; background:#f5f3ff; border:1px solid #e5e7eb; border-radius:999px; font-size:.75rem; padding:2px 6px }

    /* Semana / Día rejilla */
    #calGrid.calpro-week{ grid-template-columns: 72px repeat(7, 1fr); }
    #calGrid.calpro-day{ grid-template-columns: 72px 1fr; }
    .calpro-colhead{ font-weight:800; padding:8px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:5; }
    .calpro-hour{ border-top:1px dashed #e5e7eb; min-height:44px; position:relative; font-size:.78rem; }
    .calpro-hour-label{ position:sticky; left:0; font-weight:700; color:var(--muted); padding:6px 4px; background:#f8fafc }
    .calpro-slot{ border-top:1px dashed #f1f5f9; min-height:44px; position:relative; cursor: crosshair; background:#fff }
    .calpro-today{ background: linear-gradient(180deg, rgba(16,185,129,0.08), transparent 60%); }
    .calpro-now{ position:absolute; left:0; right:0; height:2px; background:var(--danger); box-shadow: 0 0 0 1px var(--danger); pointer-events:none; }
    .calpro-now-dot{ position:absolute; left:-4px; top:-3px; width:8px; height:8px; border-radius:50%; background:var(--danger); }

    .calpro-event{ position:absolute; left:6px; right:6px; border-radius:10px; border:1px solid #c7d2fe; background:#eef2ff; padding:6px 8px; font-size:.82rem; overflow:hidden; user-select:none; }
    .calpro-event.dragging{ opacity:.6; outline:2px dashed #60a5fa }

    /* Lateral */
    .side-panel{ border-left:1px solid var(--border); padding: 10px; overflow:auto; background:#fff; border-radius:12px }
    .side-panel h3{ margin:0 0 8px 0; font-size:1rem; color:#111 }
    .side-panel .nota{ width:100%; min-height:140px; resize:vertical; padding:10px; border-radius:12px; border:1px solid #e5e5ef; font-family:inherit; font-size:.98rem; background:#fbfdff }
    .side-panel .row{ display:flex; gap:8px; margin-top:8px }
    .btn-guardar{ background: var(--accent); color: #fff; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer }
    .btn-borrar{ background: #ef4444; color:#fff; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer }
    .tool-btn{ cursor:pointer }

    .overlay-back{ position:absolute; left: 10px; bottom: 10px; background:#eef2ff; border: 1px solid #dbe2ff; border-radius: 999px; padding: 8px 12px; display:flex; align-items:center; gap:8px; cursor:pointer; }

    @media (max-width:1024px){
      .agenda{ width:min(60vw,420px) }
      .cal-main{ grid-template-columns:1fr }
      .side-panel{ border-left:none; border-top:1px solid var(--border) }
    }
    @media (max-width:640px){
      .agenda{ width:min(98vw,420px) }
      .cal-grid{ gap:4px; grid-auto-rows:minmax(54px,1fr); padding:4px }
      .cal-dia{ min-height:54px; font-size:.95rem }
      .calendario-content{ border-radius:10px }
      .cal-header{ padding:8px 6px }
      .side-panel{ padding:6px }
    }

    /* ===== Event Editor Modal ===== */
    #eventEditorBackdrop{ position:fixed; inset:0; background: rgba(16,18,27,.45); backdrop-filter: blur(2px); display:flex; align-items:center; justify-content:center; z-index:9999; }
    #eventEditor{ width:min(640px,95vw); background:#fff; border-radius:16px; border:1px solid #e5e7eb; box-shadow: 0 20px 60px rgba(0,0,0,.18); padding:16px; color:#111 }
    #eventEditor h3{ margin:0 0 6px 0; font-size:1.1rem; }
    .ee-row{ display:flex; gap:10px; margin-top:8px; }
    .ee-row > label{ display:flex; flex-direction:column; gap:4px; flex:1; font-size:.9rem; }
    .ee-row input,.ee-row textarea{ border:1px solid #dfe3ea; border-radius:10px; padding:8px; font-size:1rem }
    .ee-actions{ display:flex; justify-content:space-between; gap:8px; margin-top:12px; }
    .ee-actions-right{ display:flex; gap:8px; }
    .ee-btn{ padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:700; }
    .ee-btn.primary{ background:#111; color:#fff; border-color:#111; }
    .ee-btn.danger{ background:#ef4444; color:#fff; border-color:#ef4444 }
  </style>
</head>
<body>

<!-- ===== Login (IDs preservados; la lógica Firebase se mantiene externa) ===== -->
<div id="loginModal" class="login-wrapper">
  <div class="login-container">
    <div class="login-left">
      <h1>Bienvenido<br>de nuevo</h1>
      <p>Accede a tu <strong>Agenda + Calendario</strong> para planificar tu día con notas y eventos.</p>
      <div class="social-icons">
        <a href="#" aria-label="Facebook" title="Facebook">f</a>
        <a href="#" aria-label="X/Twitter" title="X/Twitter">x</a>
        <a href="#" aria-label="Instagram" title="Instagram">i</a>
        <a href="#" aria-label="YouTube" title="YouTube">y</a>
      </div>
    </div>
    <div class="login-right">
      <h2 id="authTitle">Iniciar sesión</h2>
      <form id="manualLoginForm" class="login-form" autocomplete="on">
        <input id="loginEmail" type="email" placeholder="Correo electrónico" autocomplete="username" required />
        <input id="loginPassword" type="password" placeholder="Contraseña" autocomplete="current-password" required />
        <div class="remember">
          <input type="checkbox" id="rememberMe"><label for="rememberMe">Recuérdame</label>
        </div>
        <button id="manualLoginBtn" type="submit">Entrar</button>
      </form>
      <form id="registerForm" class="login-form" style="display:none;">
        <input id="registerEmail" type="email" placeholder="Correo electrónico" autocomplete="username" required />
        <input id="registerPassword" type="password" placeholder="Contraseña (mín. 6 caracteres)" required />
        <input id="registerPassword2" type="password" placeholder="Repite la contraseña" required />
        <button id="registerBtn" type="submit">Crear cuenta</button>
      </form>
      <button id="modalLoginGoogle" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"/> Continuar con Google
      </button>
      <p class="switch-auth" id="switchToRegister">¿No tienes cuenta? <a href="#" id="toRegister">Crear una cuenta</a></p>
      <p class="switch-auth" id="switchToLogin" style="display:none;">¿Ya tienes cuenta? <a href="#" id="toLogin">Iniciar sesión</a></p>
      <div id="loginError" class="login-error" role="alert" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- ===== App ===== -->
<div class="stage" id="mainApp" style="display:none;">
  <div class="agenda" id="agenda">
    <div class="tapa" id="tapa" role="button" aria-pressed="false" tabindex="0" aria-label="Abrir agenda">
      <div class="lomo" aria-hidden="true"></div>
      <div class="banda" id="bandaAno">2025</div>
      <div class="cara">
        <div class="mes-portada" id="mesPortada"></div>
        <div class="dia-wrap"><div class="dia-portada" id="diaPortada"></div></div>
        <div class="hora-actual" id="horaActual"></div>
      </div>
    </div>
    <div class="indice" aria-live="polite">
      <div class="indice-content" id="indiceContent">
        <h2>ÍNDICE</h2>
        <table class="indice-table" id="tablaMeses" aria-label="Tabla de meses">
          <tr><td data-mes="0">01-ENERO</td><td data-mes="6">07-JULIO</td></tr>
          <tr><td data-mes="1">02-FEBRERO</td><td data-mes="7">08-AGOSTO</td></tr>
          <tr><td data-mes="2">03-MARZO</td><td data-mes="8">09-SEPTIEMBRE</td></tr>
          <tr><td data-mes="3">04-ABRIL</td><td data-mes="9">10-OCTUBRE</td></tr>
          <tr><td data-mes="4">05-MAYO</td><td data-mes="10">11-NOVIEMBRE</td></tr>
          <tr><td data-mes="5">06-JUNIO</td><td data-mes="11">12-DICIEMBRE</td></tr>
        </table>
        <div class="indice-row-actions">
          <button class="indice-flecha-btn" id="btnVolverPortada">Portada</button>
          <button class="indice-btn" id="btnAbrirCalendarioActual">Abrir mes actual</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Calendario Overlay ===== -->
<div class="calendario" id="overlayCal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="calendario-bg" id="overlayBg" aria-hidden="true"></div>
  <div class="calendario-content" role="document">
    <div class="cal-header">
      <button class="calendario-nav-btn" id="btnMesAnterior" title="Mes anterior" aria-label="Mes anterior">&#x276E;</button>
      <h2 id="calTitulo">MES AÑO</h2>
      <button class="calendario-nav-btn" id="btnMesSiguiente" title="Mes siguiente" aria-label="Mes siguiente">&#x276F;</button>
      <div class="toolbar">
        <button class="tool-btn" id="btnHoy">Hoy</button>
        <button class="tool-btn" id="btnLimpiarMes">Limpiar mes</button>
      </div>
    </div>

    <div class="calpro-bar" id="calProBar" role="toolbar" aria-label="Controles de calendario">
      <div class="calpro-left">
        <button class="calpro-btn" id="btnModeMes" aria-pressed="true">Mes</button>
        <button class="calpro-btn" id="btnModeSemana">Semana</button>
        <button class="calpro-btn" id="btnModeDia">Día</button>
      </div>
      <div class="calpro-right">
        <span class="calpro-badge" id="calProInfo"></span>
        <button class="calpro-btn" id="btnPrev" title="Anterior">◀</button>
        <button class="calpro-btn" id="btnNext" title="Siguiente">▶</button>
        <button class="calpro-btn" id="btnNotif" title="Activar notificaciones">🔔</button>
      </div>
    </div>

    <div class="cal-main">
      <div class="cal-grid-wrap">
        <div class="cal-grid" id="calGrid" role="grid" aria-readonly="true"></div>
      </div>
      <aside class="side-panel" aria-live="polite">
        <h3 id="sideTitulo">Día —</h3>
        <textarea class="nota" id="notaDia" placeholder="Escribe una nota para este día..."></textarea>
        <div class="row">
          <button class="btn-guardar" id="btnGuardarNota">Guardar</button>
          <button class="btn-borrar" id="btnBorrarNota">Borrar</button>
        </div>
        <div class="row">
          <button class="tool-btn" id="btnToggleEvento">Añadir/Quitar evento</button>
          <button class="tool-btn" id="btnToggleSticker">Añadir/Quitar sticker</button>
        </div>
      </aside>
    </div>

    <button class="overlay-back" id="btnVolverIndice" title="Volver al índice" aria-label="Volver al índice">&#x2B05; Volver</button>
  </div>
</div>

<!-- ===== Templates ===== -->
<template id="tplEventEditor">
  <div id="eventEditorBackdrop">
    <div id="eventEditor" role="dialog" aria-modal="true" aria-labelledby="eeTitle">
      <h3 id="eeTitle">Nuevo evento</h3>
      <div class="ee-row">
        <label>Título<input id="eeTitulo" placeholder="Título del evento" /></label>
      </div>
      <div class="ee-row">
        <label>Fecha<input id="eeFecha" type="date" /></label>
        <label>Inicio<input id="eeInicio" type="time" value="09:00"/></label>
        <label>Fin<input id="eeFin" type="time" value="10:00"/></label>
      </div>
      <div class="ee-row">
        <label>Notas<textarea id="eeNota" rows="4" placeholder="Notas..."></textarea></label>
      </div>
      <div class="ee-actions">
        <button class="ee-btn danger" id="eeEliminar" style="display:none">Eliminar</button>
        <div class="ee-actions-right">
          <button class="ee-btn" data-close>Cancelar</button>
          <button class="ee-btn primary" id="eeGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
/* =====================================================================
   UTILIDADES + ESTADO GLOBAL (respetando contratos con tu módulo Firebase)
   ===================================================================== */
const $ = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const diasCorto = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
const now = new Date();
const ANYO = now.getFullYear();

// Exponer contenedor para funciones Firestore (será poblado por tu script de Firebase)
window.firebaseFirestore = window.firebaseFirestore || { doc:null, getDoc:null, setDoc:null, updateDoc:null };

// Estado sincronizado con tu módulo Firebase (NO tocar nombres)
let notas = {};        // mapa "mes-dia" -> string
let eventos = {};      // mapa legacy "mes-dia" -> true
let eventosPro = {};   // mapa "mes-dia" -> [{id,titulo,inicio,fin,nota}]
let stickers = {};     // mapa "mes-dia" -> true

let db = null;                 // Firestore instance (la pone tu módulo)
let currentUserData = null;    // {uid,...} (la pone tu módulo)

// Mes/día visible
let mesVisible = new Date().getMonth();
let diaActivo = { mes: mesVisible, dia: new Date().getDate() };

// =============================================================
// Sincronizadores con window.user* (tu script los actualizará)
// =============================================================
Object.defineProperty(window, 'userNotes', { get(){return notas}, set(v){ notas=v||{}; actualizarCalendarioUI(); } });
Object.defineProperty(window, 'userEvents', { get(){return eventos}, set(v){ eventos=v||{}; actualizarCalendarioUI(); } });
Object.defineProperty(window, 'userEventsPro', { get(){return eventosPro}, set(v){ eventosPro=v||{}; actualizarCalendarioUI(); } });
Object.defineProperty(window, 'userStickers', { get(){return stickers}, set(v){ stickers=v||{}; actualizarCalendarioUI(); } });

// API pública para que tu módulo Firebase pueda actualizar refs
window.actualizarCalendarioUI = function(){
  db = window.db;
  currentUserData = window.currentUserData;
  construirSegunModo();
  actualizarSidePanel();
};

function keyDay(mes, dia){ return mes + '-' + dia; }
function uid(){ return Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4); }

async function guardarDatosUsuarioEnFirestore(campo, valor){
  if (!window.firebaseFirestore || !window.firebaseFirestore.setDoc || !window.db || !window.currentUserData?.uid){
    // Aún no hay sesión o Firestore listo: no rompas la UI
    console.warn('Firestore no disponible aún; difiriendo guardado de', campo);
    return;
  }
  const { doc, setDoc } = window.firebaseFirestore;
  const userDocRef = doc(window.db, 'users', window.currentUserData.uid);
  try{
    await setDoc(userDocRef, { [campo]: valor }, { merge: true });
  }catch(err){ console.error('Error guardando', campo, err); }
}

// =====================================================================
// Portada + Índice
// =====================================================================
const agenda = $('#agenda');
const tapa = $('#tapa');
const bandaAno = $('#bandaAno');
const mesPortada = $('#mesPortada');
const diaPortada = $('#diaPortada');

bandaAno.textContent = ANYO;
mesPortada.textContent = mesesN[now.getMonth()];
diaPortada.textContent = now.getDate();

function updateHoraActual(){
  const el = $('#horaActual'); if(!el) return;
  const opts = { hour:'2-digit', minute:'2-digit', second:'2-digit' };
  const hora = new Date().toLocaleTimeString(undefined, opts);
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  el.textContent = `${hora} (${tz})`;
}
updateHoraActual(); setInterval(updateHoraActual, 1000);

tapa.addEventListener('click', toggleAgenda);
tapa.addEventListener('keydown', e=>{ if(['Enter',' '].includes(e.key)){ e.preventDefault(); toggleAgenda(); } });
$('#btnVolverPortada').addEventListener('click', ()=> agenda.classList.remove('abierta'));

function toggleAgenda(){
  const abierta = agenda.classList.toggle('abierta');
  tapa.setAttribute('aria-pressed', abierta ? 'true' : 'false');
}

(function initIndice(){
  const mesActual = now.getMonth();
  $$('#tablaMeses td[data-mes]').forEach(td=>{
    if (+td.dataset.mes === mesActual) td.classList.add('mes-actual');
    td.addEventListener('click', ()=> abrirCalendario(+td.dataset.mes));
  });
  $('#btnAbrirCalendarioActual').addEventListener('click', ()=> abrirCalendario(mesActual));
})();

// =====================================================================
// Calendario Overlay + Vistas
// =====================================================================
const overlay = $('#overlayCal');
const overlayBg = $('#overlayBg');
const calTitulo = $('#calTitulo');
const grid = $('#calGrid');
const btnPrevMes = $('#btnMesAnterior');
const btnNextMes = $('#btnMesSiguiente');
const btnVolverIndice = $('#btnVolverIndice');
const btnHoy = $('#btnHoy');
const btnLimpiarMes = $('#btnLimpiarMes');

// Side panel
const sideTitulo = $('#sideTitulo');
const notaTextarea = $('#notaDia');
const btnGuardarNota = $('#btnGuardarNota');
const btnBorrarNota = $('#btnBorrarNota');
const btnToggleEvento = $('#btnToggleEvento');
const btnToggleSticker = $('#btnToggleSticker');

function abrirCalendario(mes){
  mesVisible = mes;
  overlay.classList.add('visible');
  overlay.setAttribute('aria-hidden','false');
  setMode('mes');
  setTimeout(()=>{
    const hoy = (mes === now.getMonth()) ? now.getDate() : 1;
    const c = grid.querySelector(`[data-dia="${hoy}"]`);
    if (c) seleccionarDia(mes, hoy, c);
  },0);
}

function cerrarCalendario(){
  overlay.classList.remove('visible');
  overlay.setAttribute('aria-hidden','true');
}
$('#btnVolverIndice').addEventListener('click', cerrarCalendario);
document.addEventListener('keydown', e=>{ if(overlay.classList.contains('visible') && e.key==='Escape') cerrarCalendario(); });
btnHoy.addEventListener('click', ()=> abrirCalendario(now.getMonth()));
btnLimpiarMes.addEventListener('click', limpiarMesConfirm);
btnPrevMes.addEventListener('click', ()=> navegarMes(-1));
btnNextMes.addEventListener('click', ()=> navegarMes(+1));
function navegarMes(delta){ mesVisible = (mesVisible + delta + 12) % 12; setMode('mes'); }

function aplicarTemaMes(m){
  const temas = {
    0:'linear-gradient(135deg, #dff7ff 0%, #b7eaff 100%)',
    1:'linear-gradient(135deg, #e8f7ff 0%, #c9e8ff 100%)',
    2:'linear-gradient(135deg, #fff1c1 0%, #ffd280 100%)',
    3:'linear-gradient(135deg, #f5e5ff 0%, #cfe3ff 100%)',
    4:'linear-gradient(135deg, #fff8d6 0%, #ffd95a 100%)',
    5:'linear-gradient(135deg, #ffe082 0%, #ffd54f 100%)',
    6:'linear-gradient(135deg, #ffe082 0%, #ffb300 100%)',
    7:'linear-gradient(135deg, #ffd54f 0%, #ffb300 100%)',
    8:'linear-gradient(135deg, #c9f1ff 0%, #e7fbff 100%)',
    9:'linear-gradient(135deg, #ffe0b2 0%, #ffb74d 100%)',
    10:'linear-gradient(135deg, #ffe082 0%, #fbc02d 100%)',
    11:'linear-gradient(135deg, #e0f7fa 0%, #b2e0f7 100%)',
  };
  overlayBg.style.background = temas[m] || temas[0];
}

// =====================================================================
// Vista MES
// =====================================================================
function construirMes(mes){
  aplicarTemaMes(mes);
  const anyo = ANYO;
  const primerDia = new Date(anyo, mes, 1).getDay();
  const diasEnMes = new Date(anyo, mes+1, 0).getDate();
  calTitulo.textContent = `${mesesN[mes].toUpperCase()} ${anyo}`;

  grid.classList.remove('calpro-week','calpro-day');
  grid.innerHTML = '';

  // Cabeceras
  diasCorto.forEach(d=>{
    const h = document.createElement('div');
    h.className = 'cal-dia-header'; h.textContent = d; grid.appendChild(h);
  });
  // Vacíos previos
  for(let i=0;i<primerDia;i++){ const v = document.createElement('div'); v.setAttribute('aria-hidden','true'); grid.appendChild(v); }

  // Días
  for(let d=1; d<=diasEnMes; d++){
    const cell = document.createElement('div');
    cell.className = 'cal-dia';
    cell.dataset.dia = d;
    cell.setAttribute('role','gridcell');
    cell.setAttribute('tabindex','0');
    if (mes === now.getMonth() && d === now.getDate()) cell.classList.add('cal-dia-hoy');

    const num = document.createElement('div');
    num.className = 'cal-dia-num'; num.textContent = d;
    cell.appendChild(num);

    // Lista de eventos del día (+n)
    const k = keyDay(mes,d);
    const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
    if(list.length){
      const cont = document.createElement('div');
      cont.className = 'month-list';
      const max = 2; // mostrar hasta 2, resto en +n para no romper layout
      list.slice(0,max).forEach(e=>{
        const it = document.createElement('div');
        it.className='month-event';
        it.textContent = `${e.inicio || '—'} ${e.titulo || 'Evento'}`;
        cont.appendChild(it);
      });
      if(list.length>max){
        const more = document.createElement('button');
        more.className='month-more'; more.textContent = `+${list.length-max}`;
        more.addEventListener('click', ev=>{ ev.stopPropagation(); setMode('dia', new Date(ANYO, mes, d)); });
        cell.appendChild(more);
      }
      cell.appendChild(cont);
    }else if(eventos[k]){
      // legacy marker
      const cont = document.createElement('div');
      cont.className = 'month-list';
      const it = document.createElement('div'); it.className='month-event'; it.textContent='Evento';
      cont.appendChild(it);
      cell.appendChild(cont);
    }

    cell.addEventListener('click', ()=> seleccionarDia(mes, d, cell));
    cell.addEventListener('keydown', (e)=>{
      if (['Enter',' '].includes(e.key)){ e.preventDefault(); seleccionarDia(mes,d,cell); }
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); moverFocoMes(cell, e.key); }
    });

    grid.appendChild(cell);
  }
}

function moverFocoMes(cell, key){
  const cells = $$('#calGrid .cal-dia');
  const idx = cells.indexOf(cell);
  const cols = 7;
  let next = idx;
  if (key==='ArrowRight') next = idx+1;
  if (key==='ArrowLeft')  next = idx-1;
  if (key==='ArrowDown')  next = idx+cols;
  if (key==='ArrowUp')    next = idx-cols;
  next = Math.max(0, Math.min(cells.length-1, next));
  cells[next]?.focus();
}

// =====================================================================
// Vista SEMANA / DÍA
// =====================================================================
let proMode = 'mes';
let fechaFocal = new Date();

const btnModeMes = $('#btnModeMes');
const btnModeSemana = $('#btnModeSemana');
const btnModeDia = $('#btnModeDia');
const btnPrev = $('#btnPrev');
const btnNext = $('#btnNext');
const btnNotif = $('#btnNotif');
const info = $('#calProInfo');

function setMode(mode, date=null){
  proMode = mode;
  if (date) fechaFocal = new Date(date);
  btnModeMes.classList.toggle('active', mode==='mes');
  btnModeSemana.classList.toggle('active', mode==='semana');
  btnModeDia.classList.toggle('active', mode==='dia');
  construirSegunModo();
}

function construirSegunModo(){
  if (proMode==='mes'){ construirMes(mesVisible); }
  else if (proMode==='semana'){ renderSemana(); }
  else { renderDia(); }
}

btnModeMes.addEventListener('click', ()=> setMode('mes'));
btnModeSemana.addEventListener('click', ()=> setMode('semana'));
btnModeDia.addEventListener('click', ()=> setMode('dia'));
btnPrev.addEventListener('click', ()=>{
  if (proMode==='mes'){ mesVisible=(mesVisible+11)%12; construirMes(mesVisible); }
  else if (proMode==='semana'){ fechaFocal.setDate(fechaFocal.getDate()-7); renderSemana(); }
  else { fechaFocal.setDate(fechaFocal.getDate()-1); renderDia(); }
});
btnNext.addEventListener('click', ()=>{
  if (proMode==='mes'){ mesVisible=(mesVisible+1)%12; construirMes(mesVisible); }
  else if (proMode==='semana'){ fechaFocal.setDate(fechaFocal.getDate()+7); renderSemana(); }
  else { fechaFocal.setDate(fechaFocal.getDate()+1); renderDia(); }
});

function mondayOf(d){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = dt.getDay(); // 0 dom .. 6 sab
  const diff = (day === 0 ? -6 : 1 - day);
  dt.setDate(dt.getDate() + diff);
  return dt;
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmt2(n){ return String(n).padStart(2,'0'); }
function toMinutes(hhmm){ const [h,m]= (hhmm||'00:00').split(':').map(Number); return h*60+m; }
function fromMinutes(min){ const h=Math.floor(min/60); const m=min%60; return `${fmt2(h)}:${fmt2(m)}`; }

function renderSemana(){
  grid.className='cal-grid calpro-week';
  grid.innerHTML='';

  const start = mondayOf(fechaFocal);
  const days = Array.from({length:7}, (_,i)=> addDays(start,i));
  const label = `${days[0].getDate()} ${mesesN[days[0].getMonth()].slice(0,3)} – ${days[6].getDate()} ${mesesN[days[6].getMonth()].slice(0,3)} ${days[6].getFullYear()}`;
  calTitulo.textContent = `SEMANA · ${label}`;

  // Columna horas
  const colHoursHead = document.createElement('div');
  colHoursHead.className='calpro-colhead'; colHoursHead.textContent='';
  grid.appendChild(colHoursHead);

  days.forEach(d=>{
    const head = document.createElement('div');
    head.className='calpro-colhead';
    head.textContent = `${diasCorto[d.getDay()]} ${d.getDate()} ${mesesN[d.getMonth()].slice(0,3)}`;
    if (isToday(d)) head.classList.add('calpro-today');
    grid.appendChild(head);
  });

  // Horas 0..23
  for(let h=0; h<24; h++){
    const hourLbl = document.createElement('div');
    hourLbl.className='calpro-hour calpro-hour-label';
    hourLbl.textContent = `${fmt2(h)}:00`;
    grid.appendChild(hourLbl);

    days.forEach(d=>{
      const slot = document.createElement('div');
      slot.className = 'calpro-slot calpro-hour';
      slot.dataset.date = toISO(d);
      slot.dataset.hour = h;
      slot.addEventListener('dblclick', ()=> abrirEditorEvento(slot.dataset.date));
      grid.appendChild(slot);
      renderEventsInSlot(slot, d, h);
    });
  }
  paintNowLine();
}

function renderDia(){
  grid.className='cal-grid calpro-day';
  grid.innerHTML='';

  const d = new Date(fechaFocal);
  calTitulo.textContent = `DÍA · ${diasCorto[d.getDay()]} ${d.getDate()} ${mesesN[d.getMonth()].toUpperCase()} ${d.getFullYear()}`;

  const headHours = document.createElement('div'); headHours.className='calpro-colhead'; grid.appendChild(headHours);
  const headDay = document.createElement('div'); headDay.className='calpro-colhead'; headDay.textContent='Horario'; if (isToday(d)) headDay.classList.add('calpro-today'); grid.appendChild(headDay);

  for(let h=0; h<24; h++){
    const hourLbl = document.createElement('div'); hourLbl.className='calpro-hour calpro-hour-label'; hourLbl.textContent = `${fmt2(h)}:00`; grid.appendChild(hourLbl);
    const slot = document.createElement('div'); slot.className='calpro-slot calpro-hour'; slot.dataset.date = toISO(d); slot.dataset.hour = h;
    slot.addEventListener('dblclick', ()=> abrirEditorEvento(slot.dataset.date));
    grid.appendChild(slot);
    renderEventsInSlot(slot, d, h);
  }
  paintNowLine();
}

function toISO(d){ return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`; }
function isToday(d){ const x=new Date(); return x.getFullYear()===d.getFullYear() && x.getMonth()===d.getMonth() && x.getDate()===d.getDate(); }

function renderEventsInSlot(slot, dateObj, hour){
  const k = keyDay(dateObj.getMonth(), dateObj.getDate());
  const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
  const within = list.filter(e=> Math.floor(toMinutes(e.inicio||'00:00')/60) === hour);
  within.forEach((e, idx)=>{
    const el = document.createElement('div');
    el.className = 'calpro-event';
    el.draggable = true;
    el.textContent = `${e.inicio} ${e.titulo}`;
    const topMin = toMinutes(e.inicio) - hour*60;
    const dur = Math.max(15, toMinutes(e.fin||e.inicio) - toMinutes(e.inicio));
    el.style.top = `${(topMin/60)*44}px`;
    el.style.height = `${(dur/60)*44 - 4}px`;

    // Drag
    el.addEventListener('dragstart', dragStart(e, k, idx));
    el.addEventListener('dragend', dragEnd);
    slot.appendChild(el);
  });

  // Allow drop to set new hour
  slot.addEventListener('dragover', e=>{ e.preventDefault(); });
  slot.addEventListener('drop', e=>{
    e.preventDefault();
    const payload = dragPayload;
    if (!payload) return;
    const tgtDate = new Date(slot.dataset.date+'T00:00');
    const kNew = keyDay(tgtDate.getMonth(), tgtDate.getDate());
    const y = e.offsetY; // 0..44
    const minutesIntoHour = Math.round((y/44)*60/15)*15; // redondeo 15'
    const newStartMin = hour*60 + minutesIntoHour;
    const dur = payload.durMin;
    const newEndMin = Math.max(newStartMin+15, newStartMin + dur);

    // mover evento
    const arrOld = Array.isArray(eventosPro[payload.k]) ? eventosPro[payload.k] : [];
    const evt = arrOld.splice(payload.idx,1)[0];
    if (!evt) return;

    const arrNew = Array.isArray(eventosPro[kNew]) ? eventosPro[kNew] : [];
    evt.inicio = fromMinutes(newStartMin);
    evt.fin = fromMinutes(newEndMin);
    arrNew.push(evt);
    eventosPro[payload.k] = arrOld;
    eventosPro[kNew] = arrNew;
    // legacy marker
    if (!arrOld.length) delete eventos[payload.k]; else eventos[payload.k] = true;
    eventos[kNew] = true;

    Promise.all([
      guardarDatosUsuarioEnFirestore('eventosPro', eventosPro),
      guardarDatosUsuarioEnFirestore('eventos', eventos)
    ]).then(()=> construirSegunModo());
  });
}

let dragPayload = null;
function dragStart(evtData, k, idx){
  return (ev)=>{
    ev.dataTransfer.effectAllowed = 'move';
    ev.currentTarget.classList.add('dragging');
    const dur = Math.max(15, toMinutes(evtData.fin||evtData.inicio) - toMinutes(evtData.inicio));
    dragPayload = { k, idx, durMin: dur };
  }
}
function dragEnd(ev){
  ev.currentTarget.classList.remove('dragging');
  dragPayload = null;
}

function paintNowLine(){
  // Dibujar línea roja actual en vista semana/día
  const cols = $$('.calpro-slot');
  if (!cols.length) return;
  const firstCol = cols[0].parentElement; // grid
  // Eliminar previas
  $$('.calpro-now').forEach(n=>n.remove());
  const d = new Date();
  const min = d.getHours()*60 + d.getMinutes();
  const y = (min/60)*44; // px

  // Para semana: una línea por cada día "hoy"
  if (proMode==='semana'){
    const start = mondayOf(fechaFocal);
    for(let i=0;i<7;i++){
      const day = addDays(start,i);
      if (isToday(day)){
        // Encontrar slots de este día
        const daySlots = $$('.calpro-slot').filter(s=> s.dataset.date === toISO(day));
        if (daySlots.length){
          const container = daySlots[0].parentElement; // grid
          const line = document.createElement('div'); line.className='calpro-now'; line.style.top = `${y}px`;
          const dot = document.createElement('div'); dot.className='calpro-now-dot';
          line.appendChild(dot);
          container.appendChild(line);
        }
      }
    }
  } else if (proMode==='dia'){
    const all = $$('.calpro-slot');
    if (all.length){
      const container = all[0].parentElement;
      const line = document.createElement('div'); line.className='calpro-now'; line.style.top = `${y}px`;
      const dot = document.createElement('div'); dot.className='calpro-now-dot';
      line.appendChild(dot);
      container.appendChild(line);
    }
  }

  // Actualizar cada minuto
  clearTimeout(paintNowLine._t);
  paintNowLine._t = setTimeout(paintNowLine, 60*1000);
}

// =====================================================================
// Selección y notas del panel lateral
// =====================================================================
function seleccionarDia(mes, dia, cell){
  $$('#calGrid .cal-dia').forEach(c=>c.classList.remove('selected'));
  if (cell) cell.classList.add('selected');
  diaActivo = { mes, dia };
  actualizarSidePanel();
}
function actualizarSidePanel(){
  if (!diaActivo) return;
  const { mes, dia } = diaActivo;
  sideTitulo.textContent = `${dia} de ${mesesN[mes]}`;
  const k = keyDay(mes, dia);
  notaTextarea.value = (notas[k] || '');
}
btnGuardarNota.addEventListener('click', async ()=>{
  if (!diaActivo) return;
  const {mes, dia} = diaActivo; const k = keyDay(mes, dia);
  const val = notaTextarea.value.trim();
  if (val) notas[k]=val; else delete notas[k];
  await guardarDatosUsuarioEnFirestore('notas', notas);
  btnGuardarNota.textContent='Guardado ✓'; setTimeout(()=> btnGuardarNota.textContent='Guardar',900);
});
btnBorrarNota.addEventListener('click', async ()=>{
  if (!diaActivo) return;
  const {mes, dia} = diaActivo; const k = keyDay(mes, dia);
  delete notas[k];
  await guardarDatosUsuarioEnFirestore('notas', notas);
  notaTextarea.value='';
});
btnToggleEvento.addEventListener('click', async ()=>{
  if (!diaActivo) return;
  const {mes, dia} = diaActivo; const k = keyDay(mes, dia);
  if (eventos[k]) delete eventos[k]; else eventos[k] = true;
  await guardarDatosUsuarioEnFirestore('eventos', eventos);
  construirSegunModo();
});
btnToggleSticker.addEventListener('click', async ()=>{
  if (!diaActivo) return;
  const {mes, dia} = diaActivo; const k = keyDay(mes, dia);
  if (stickers[k]) delete stickers[k]; else stickers[k] = true;
  await guardarDatosUsuarioEnFirestore('stickers', stickers);
});

async function limpiarMesConfirm(){
  if (mesVisible==null) return;
  if (!confirm('¿Seguro que quieres limpiar notas, eventos y stickers de este mes?')) return;
  const prefix = mesVisible + '-';
  const f = (map)=>{
    const n={}; for(const k in map){ if(!k.startsWith(prefix)) n[k]=map[k]; } return n;
  };
  notas = f(notas); eventos = f(eventos); stickers = f(stickers);
  await Promise.all([
    guardarDatosUsuarioEnFirestore('notas', notas),
    guardarDatosUsuarioEnFirestore('eventos', eventos),
    guardarDatosUsuarioEnFirestore('stickers', stickers)
  ]);
  construirSegunModo(); actualizarSidePanel();
}

// =====================================================================
// Editor de eventos + CRUD
// =====================================================================
function abrirEditorEvento(fechaISO, evtIndex){
  const tpl = $('#tplEventEditor'); if (!tpl) return;
  const node = tpl.content.firstElementChild.cloneNode(true);
  const inputTitulo = node.querySelector('#eeTitulo');
  const inputFecha = node.querySelector('#eeFecha');
  const inputIni = node.querySelector('#eeInicio');
  const inputFin = node.querySelector('#eeFin');
  const inputNota = node.querySelector('#eeNota');
  const btnEliminar = node.querySelector('#eeEliminar');
  const btnGuardar = node.querySelector('#eeGuardar');

  inputFecha.value = fechaISO || toISO(new Date());
  const dt = new Date((inputFecha.value || toISO(new Date())) + 'T00:00');
  const k = keyDay(dt.getMonth(), dt.getDate());
  const arr = Array.isArray(eventosPro[k]) ? [...eventosPro[k]] : [];

  let modo='nuevo';
  if (typeof evtIndex==='number' && arr[evtIndex]){
    modo='editar';
    const e = arr[evtIndex];
    inputTitulo.value = e.titulo || '';
    inputIni.value = e.inicio || '09:00';
    inputFin.value = e.fin || '10:00';
    inputNota.value = e.nota || '';
    btnEliminar.style.display='';
    node.querySelector('#eeTitle').textContent='Editar evento';
  }

  function cerrar(){ node.remove(); document.removeEventListener('keydown', onKey); }
  node.addEventListener('click', (e)=>{ if (e.target && e.target.hasAttribute('data-close')) cerrar(); });
  function onKey(e){ if(e.key==='Escape') cerrar(); }
  document.addEventListener('keydown', onKey);

  btnEliminar.addEventListener('click', async ()=>{
    const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
    if (typeof evtIndex==='number' && list[evtIndex]){
      list.splice(evtIndex,1); eventosPro[k]=list;
      if (!list.length) delete eventos[k]; else eventos[k]=true;
      await Promise.all([
        guardarDatosUsuarioEnFirestore('eventosPro', eventosPro),
        guardarDatosUsuarioEnFirestore('eventos', eventos)
      ]);
      construirSegunModo(); cerrar();
    }
  });

  btnGuardar.addEventListener('click', async ()=>{
    const titulo = inputTitulo.value.trim() || 'Evento';
    const inicio = inputIni.value || '09:00';
    const fin = (inputFin.value && toMinutes(inputFin.value)>toMinutes(inicio)) ? inputFin.value : fromMinutes(toMinutes(inicio)+60);
    const nota = inputNota.value.trim();
    const e = { id: uid(), titulo, inicio, fin, nota };

    const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
    if (modo==='editar' && typeof evtIndex==='number' && list[evtIndex]) list[evtIndex]=e; else list.push(e);
    eventosPro[k]=list; eventos[k]=true;
    await Promise.all([
      guardarDatosUsuarioEnFirestore('eventosPro', eventosPro),
      guardarDatosUsuarioEnFirestore('eventos', eventos)
    ]);
    construirSegunModo(); cerrar();
  });

  document.body.appendChild(node);
}

// Doble click en mes para crear evento rápido
grid.addEventListener('dblclick', (e)=>{
  if (proMode!=='mes') return;
  const cell = e.target.closest('.cal-dia'); if (!cell) return;
  const dia = +cell.dataset.dia; const fecha = new Date(ANYO, mesVisible, dia);
  abrirEditorEvento(toISO(fecha));
});

// Click en etiqueta de evento en mes -> abrir editor (primer evento)
grid.addEventListener('click', (e)=>{
  if (proMode!=='mes') return;
  const item = e.target.closest('.month-event'); if (!item) return;
  const cell = e.target.closest('.cal-dia'); if (!cell) return;
  const dia = +cell.dataset.dia; const k = keyDay(mesVisible, dia);
  const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
  if (list[0]) abrirEditorEvento(toISO(new Date(ANYO, mesVisible, dia)), 0);
});

// =====================================================================
// Notificaciones locales (10 min antes)
// =====================================================================
btnNotif.addEventListener('click', async ()=>{
  if (!('Notification' in window)) return alert('Tu navegador no soporta notificaciones.');
  const perm = await Notification.requestPermission();
  if (perm !== 'granted') return alert('Permiso denegado.');
  alert('Notificaciones activadas. Te avisaré 10 min antes de cada evento de hoy.');
  scheduleTodayNotifications();
});

function scheduleTodayNotifications(){
  if (!('Notification' in window) || Notification.permission!=='granted') return;
  const t = new Date();
  const k = keyDay(t.getMonth(), t.getDate());
  const list = Array.isArray(eventosPro[k]) ? eventosPro[k] : [];
  list.forEach(e=>{
    const startMin = toMinutes(e.inicio||'00:00');
    const nowMin = t.getHours()*60 + t.getMinutes();
    const delta = (startMin - 10) - nowMin; // minutos hasta 10 min antes
    const ms = delta * 60 * 1000;
    if (ms > 0){
      setTimeout(()=>{
        new Notification('⏰ Evento en 10 min', { body: `${e.titulo} a las ${e.inicio}` });
      }, ms);
    }
  });
}

// =====================================================================
// Arranque UI básico
// =====================================================================
document.addEventListener('DOMContentLoaded', ()=>{
  // Inicial portada
  construirMes(mesVisible);
  actualizarSidePanel();
});

</script>
</body>
</html>
